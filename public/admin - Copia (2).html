<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Administrativo - Agenda C-326</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f3f3f3;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #1a73e8;
      color: white;
      padding: 15px;
      text-align: center;
    }

    .container {
      max-width: 900px;
      background: white;
      margin: 30px auto;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      color: #333;
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 15px;
    }

    button {
      background-color: #1a73e8;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background-color: #0d5ecb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #f0f0f0;
    }

    #login-box {
      max-width: 400px;
      margin: 100px auto;
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    #logout {
      float: right;
      background: #d9534f;
    }

    #logout:hover {
      background: #c9302c;
    }

    .hidden {
      display: none;
    }

    .msg {
      text-align: center;
      margin-top: 10px;
      color: green;
      font-weight: bold;
    }

    .danger {
      background-color: #d9534f;
    }

    .danger:hover {
      background-color: #c9302c;
    }
  </style>
</head>
<body>
  <header>
    <h1>Painel Administrativo - Agenda C-326</h1>
  </header>

  <!-- Tela de Login -->
  <div id="login-box">
    <h2>Login Administrativo</h2>
    <label for="usuario">Usuário:</label>
    <input type="text" id="usuario" placeholder="Digite o usuário">

    <label for="senha">Senha:</label>
    <input type="password" id="senha" placeholder="Digite a senha">

    <button id="btnLogin">Entrar</button>
    <div id="loginMsg" class="msg"></div>
  </div>

  <!-- Painel -->
  <div id="painel" class="container hidden">
    <button id="logout">Sair</button>
    <h2>Gerenciar Agendamentos</h2>

    <label for="dataHorario">Cadastrar Horários para o Dia:</label>
    <input type="date" id="dataHorario" />
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button id="btnCadastrarHorarios">Gerar Horários Padrão</button>
      <button id="btnExcluirHorarios" class="danger">Excluir Todos os Horários do Dia</button>
      <button id="btnListarHorarios">Listar Horários</button>
    </div>
    <div id="msgCadastro" class="msg"></div>

    <div id="listaHorarios"></div>

    <hr />

    <label>Filtrar Agendamentos por Período:</label>
    <div style="display: flex; gap: 10px;">
      <input type="date" id="inicio">
      <input type="date" id="fim">
      <button id="btnFiltrar">Filtrar</button>
    </div>

    <table id="tabelaAgendamentos">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nome</th>
          <th>CPF</th>
          <th>Data</th>
          <th>Hora</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const loginBox = document.getElementById("login-box");
    const painel = document.getElementById("painel");
    const msgLogin = document.getElementById("loginMsg");

    // === LOGIN ===
    document.getElementById("btnLogin").addEventListener("click", async () => {
      const usuario = document.getElementById("usuario").value.trim();
      const senha = document.getElementById("senha").value.trim();

      if (!usuario || !senha) {
        msgLogin.textContent = "Preencha usuário e senha!";
        msgLogin.style.color = "red";
        return;
      }

      const resp = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usuario, senha })
      });

      const data = await resp.json();
      if (data.success) {
        loginBox.classList.add("hidden");
        painel.classList.remove("hidden");
        carregarAgendamentos();
      } else {
        msgLogin.textContent = "Usuário ou senha incorretos!";
        msgLogin.style.color = "red";
      }
    });

    // === LOGOUT ===
    document.getElementById("logout").addEventListener("click", async () => {
      await fetch("/api/logout", { method: "POST" });
      painel.classList.add("hidden");
      loginBox.classList.remove("hidden");
      msgLogin.textContent = "Sessão encerrada.";
      msgLogin.style.color = "green";
    });

    // === CADASTRAR HORÁRIOS ===
    document.getElementById("btnCadastrarHorarios").addEventListener("click", async () => {
      const dataHorario = document.getElementById("dataHorario").value;
      if (!dataHorario) {
        alert("Selecione uma data!");
        return;
      }

      const resp = await fetch("/admin/api/cadastrar-horarios", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: dataHorario })
      });

      const data = await resp.json();
      const msg = document.getElementById("msgCadastro");
      msg.textContent = data.message;
      msg.style.color = data.success ? "green" : "red";
    });

    // === LISTAR HORÁRIOS ===
    document.getElementById("btnListarHorarios").addEventListener("click", async () => {
      const res = await fetch("/admin/api/horarios");
      const body = await res.json();

      if (!body.success) {
        alert(body.message || "Erro ao carregar horários");
        return;
      }

      const lista = document.getElementById("listaHorarios");
      if (body.rows.length === 0) {
        lista.innerHTML = "<p><i>Nenhum horário encontrado.</i></p>";
        return;
      }

      const html = ['<table><thead><tr><th>ID</th><th>Data</th><th>Hora</th><th>Disponível</th></tr></thead><tbody>'];
      body.rows.forEach(r => {
        const dataBR = new Date(r.data + "T00:00:00-03:00").toLocaleDateString("pt-BR");
        html.push(`<tr><td>${r.id}</td><td>${dataBR}</td><td>${r.hora}</td><td>${r.disponivel ? "✅" : "❌"}</td></tr>`);
      });
      html.push("</tbody></table>");
      lista.innerHTML = html.join("");
    });

    // === EXCLUIR TODOS HORÁRIOS DE UMA DATA ===
    document.getElementById("btnExcluirHorarios").addEventListener("click", async () => {
      const dataHorario = document.getElementById("dataHorario").value;
      if (!dataHorario) {
        alert("Selecione uma data!");
        return;
      }
      if (!confirm("Tem certeza que deseja excluir TODOS os horários dessa data?")) return;

      const resp = await fetch(`/admin/api/horarios/${dataHorario}`, { method: "DELETE" });
      const data = await resp.json();

      const msg = document.getElementById("msgCadastro");
      msg.textContent = data.message;
      msg.style.color = data.success ? "green" : "red";
    });

    // === FILTRAR AGENDAMENTOS ===
    document.getElementById("btnFiltrar").addEventListener("click", async () => {
      carregarAgendamentos();
    });

    // === CARREGAR AGENDAMENTOS ===
    async function carregarAgendamentos() {
      const inicio = document.getElementById("inicio").value;
      const fim = document.getElementById("fim").value;

      let url = "/admin/api/agendamentos";
      if (inicio && fim) url += `?inicio=${inicio}&fim=${fim}`;

      const resp = await fetch(url);
      const data = await resp.json();

      const tbody = document.querySelector("#tabelaAgendamentos tbody");
      tbody.innerHTML = "";

      if (data.success && data.rows.length > 0) {
        data.rows.forEach(a => {
          const dataBR = new Date(a.data + "T00:00:00-03:00").toLocaleDateString("pt-BR");
          tbody.innerHTML += `
            <tr>
              <td>${a.id}</td>
              <td>${a.nome}</td>
              <td>${a.cpf}</td>
              <td>${dataBR}</td>
              <td>${a.hora}</td>
              <td><button class="danger" onclick="excluirAgendamento(${a.id})">Excluir</button></td>
            </tr>
          `;
        });
      } else {
        tbody.innerHTML = "<tr><td colspan='6'>Nenhum agendamento encontrado</td></tr>";
      }
    }

    // === EXCLUIR AGENDAMENTO INDIVIDUAL ===
    async function excluirAgendamento(id) {
      if (!confirm("Deseja realmente excluir este agendamento?")) return;
      const resp = await fetch(`/admin/api/agendamentos/${id}`, { method: "DELETE" });
      const data = await resp.json();
      alert(data.message);
      carregarAgendamentos();
    }

    window.excluirAgendamento = excluirAgendamento;
  </script>
</body>
</html>
