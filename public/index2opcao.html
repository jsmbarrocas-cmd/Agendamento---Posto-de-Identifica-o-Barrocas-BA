<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agenda C-326</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
    }
    .container {
      width: 400px;
      margin: 40px auto;
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 0 10px #ccc;
    }
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
      color: #333;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      border: none;
      color: white;
      cursor: pointer;
      margin-top: 15px;
      font-weight: bold;
    }
    button:hover {
      background-color: #0056b3;
    }
    .mensagem {
      margin-top: 15px;
      text-align: center;
      font-weight: bold;
    }
    .sucesso { color: green; }
    .erro { color: red; }
    .link-admin {
      text-align: center;
      margin-top: 20px;
    }
    .link-admin a {
      color: #007bff;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Agendamento</h2>
    <form id="formAgendar">
      <label for="nome">Nome:</label>
      <input type="text" id="nome" required />

      <label for="cpf">CPF:</label>
      <input type="text" id="cpf" maxlength="14" required />

      <label for="email">E-mail:</label>
      <input type="email" id="email" required />

      <label for="telefone">Telefone:</label>
      <input type="text" id="telefone" maxlength="15" required />

      <label for="data">Data:</label>
      <input type="date" id="data" required />

      <label for="hora">Horário:</label>
      <select id="hora" required>
        <option value="">Selecione a data primeiro</option>
      </select>

      <button type="submit">Agendar</button>
    </form>
    <div id="mensagem" class="mensagem"></div>
    <div class="link-admin">
      <a href="/login.html">Acesso Administrativo</a>
    </div>
  </div>

  <script>
    // ===== Máscara de CPF e telefone =====
    document.getElementById("cpf").addEventListener("input", function (e) {
      let v = e.target.value.replace(/\D/g, "");
      if (v.length <= 11)
        e.target.value = v
          .replace(/(\d{3})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d{1,2})$/, "$1-$2");
    });

    document.getElementById("telefone").addEventListener("input", function (e) {
      let v = e.target.value.replace(/\D/g, "");
      if (v.length > 10)
        e.target.value = v.replace(/(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
      else e.target.value = v.replace(/(\d{2})(\d{4})(\d{0,4})/, "($1) $2-$3");
    });

    // ===== BLOQUEAR DATAS SEM HORÁRIOS DISPONÍVEIS =====
    const dataInput = document.getElementById("data");
    const hoje = new Date().toISOString().split("T")[0];
    dataInput.min = hoje;

    let datasDisponiveis = [];

    async function carregarDatasDisponiveis() {
      try {
        const resp = await fetch("/api/datas-disponiveis");
        datasDisponiveis = await resp.json();

        // Desabilita visualmente (datas não disponíveis)
        dataInput.addEventListener("input", e => {
          if (!datasDisponiveis.includes(e.target.value)) {
            alert("Esta data não possui horários disponíveis.");
            e.target.value = "";
            document.getElementById("hora").innerHTML =
              '<option value="">Selecione a data primeiro</option>';
          } else carregarHorarios(e.target.value);
        });
      } catch (err) {
        console.error("Erro ao carregar datas:", err);
      }
    }

    // ===== Carregar horários =====
    async function carregarHorarios(dataSelecionada) {
      const resp = await fetch(`/api/horarios-disponiveis?data=${dataSelecionada}`);
      const horas = await resp.json();
      const select = document.getElementById("hora");
      select.innerHTML = "";

      if (horas.length === 0) {
        select.innerHTML = '<option value="">Sem horários disponíveis</option>';
      } else {
        select.innerHTML = '<option value="">Selecione um horário</option>';
        horas.forEach(h => {
          const op = document.createElement("option");
          op.value = h.hora;
          op.textContent = h.hora;
          select.appendChild(op);
        });
      }
    }

    // ===== Enviar agendamento =====
    document.getElementById("formAgendar").addEventListener("submit", async (e) => {
      e.preventDefault();
      const nome = document.getElementById("nome").value.trim();
      const cpf = document.getElementById("cpf").value.trim();
      const email = document.getElementById("email").value.trim();
      const telefone = document.getElementById("telefone").value.trim();
      const data = document.getElementById("data").value;
      const hora = document.getElementById("hora").value;

      const msg = document.getElementById("mensagem");
      msg.textContent = "Enviando...";
      msg.className = "mensagem";

      const resp = await fetch("/api/agendar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nome, cpf, email, telefone, data, hora }),
      });
      const result = await resp.json();

      if (result.success) {
        msg.textContent = result.message;
        msg.classList.add("sucesso");
        if (result.comprovante)
          window.open(result.comprovante, "_blank");
        document.getElementById("formAgendar").reset();
        document.getElementById("hora").innerHTML =
          '<option value="">Selecione a data primeiro</option>';
      } else {
        msg.textContent = result.message;
        msg.classList.add("erro");
      }
    });

    // ===== Inicializar =====
    carregarDatasDisponiveis();
  </script>
</body>
</html>
